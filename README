#********************************************************************#
#*                              READ ME                             *#
#                                                                    #
#*                      更新日 2014 年  11 月 11 日                 *#
######################################################################
#                ストリーミングレプリケーション操作キット            #
######################################################################
[スクリプト使用の前に]
 本スクリプトは同期レプリケーション構成のデータベースに障害が発生した
 場合のフェイルオーバおよび、フェイルバック操作を簡易的に行うためのス
 クリプトです。
 このキットは全てのノードの同一パス上に配置されることを前提に動作します。

 本スクリプトは2台構成の同期レプリケーション環境での使用を前提に
 作成しています。使用前に以下の環境が整っていることをご確認ください。
 ・マスタにするPostgreSQLのinitdbが完了している。
 ・WAL転送用ネットワークが確立されている。
 ・本スクリプトファイル一式が各ノードから参照できる位置に配置されている。
 ・WAL転送用ネットワークを利用してPostgreSQL実行ユーザでのパスフレーズ
   なしsshログインが可能になっている。

[pgrepli.confの設定]
 本スクリプトは同梱のpgrepli.confファイルに設定された環境変数を使用
 して動作します。
----
PRM_CONFIG
 プライマリサーバ用として読み込まれる設定パラメータを記載するファイルの絶対パス(ファイル名)です。
 状態遷移によってこのファイルがノードのpostgresql.confにincludeされます。

STB_CONFIG
 スタンバイサーバ用として読み込まれる設定パラメータを記載するファイルの絶対パス(ファイル名)です。
 状態遷移によってこのファイルがノードのpostgresql.confにincludeされます。

UNI_CONFIG
 縮退サーバ用として読み込まれる設定パラメータを記載するファイルの絶対パス(ファイル名)です。
 フェイルオーバ時、縮退サーバにはこのファイルの設定が縮退ノードのpostgresql.confにincludeされます。

PGUSER
 本スクリプトおよびレプリケーションで使用するPostgreSQLユーザ名です。

PGHOME
 PostgreSQLのインストールディレクトリです.$PGHOME/binに
 PostgreSQLの各種コマンドが格納されていることを前提としています。

ARCHIVEDIR
 PostgreSQLのWALをアーカイブするディレクトリの絶対パスです。
 プライマリ/スタンバイとも同一パスを前提としています。

PGDATA_0
 1つめのノードのPostgreSQLのデータベースディレクトリの絶対パスです。

PGPORT_0
 1つめのノードのPostgreSQLの起動ポート番号です。

PGDATA_1
 2つめのノードのデータベースディレクトリの絶対パスです。

PGPORT_1
 2つめのノードのPostgreSQLの起動ポート番号です。

WALSTREAM_FIP
 レプリケーションやデータ同期の際に使用するWAL転送ネットワークの
 フローティングIPアドレスです。
-------

[スクリプトの説明]
fover_start.sh
 プライマリ、スタンバイのいずれかに障害が発生しノードが停止した際、
 障害が発生していないノード上でこのスクリプトを実行してください。
 当該ノードが縮退稼動をするための手順が実行されます。
 また、DBが起動していない場合はこのスクリプトを実行することで、
 当該DBを縮退モードとして稼働させます。
 [仕様]
  PostgreSQL実行ユーザで実行してください。
  実行するノードのノード変数(node0/node1)を引数に指定してください。
  プライマリノードで実行した場合、縮退稼動用の設定ファイルを適用します。
  スタンバイノードで実行した場合、プライマリへの昇格コマンドを発行後、
  縮退稼動用の設定ファイルを適用します。
  実効するノード用のpgrepli.confを読み込み、mode_changer.sh
  を内部で実行しています。

fback_start.sh
 障害ノードの修復完了後、同期レプリケーション環境を再構成するため
 には、このスクリプトを起動するノード上で実行してください。
 引数に応じた方法で同期処理を行い、レプリケーション環境が再構成
 されます。
 [仕様]
  PostgreSQL実行ユーザで実行してください。
  実行するノードのノード変数(node0/node1)を第２引数に指定してください。
  実行するノード用のpgrepli.confを読み込み、mode_changer.sh
  を内部で実行しています。
  引数を一つだけ入力する必要があります。
  "rebuild"が入力された場合、障害ノードのデータを再構築します。
  マスタのPostgreSQL上のデータ全てをWAL転送用ネットワークを使用
  して転送します。
  "walreply"が入力された場合、障害ノードのWAL同期を行います。
  "revive"が入力された場合、walreply->rebuildの順で復旧試行します。  

  より詳細な説明はスクリプト内の説明を参照してください。

mode_changer.sh
 それぞれの役割に合った設定ファイルをPostgreSQLに適用するため
 のスクリプトです。内部的に使用される共通スクリプトであり、
 使用者が直接実行する必要はありません。

[スクリプト使用時の注意点]
fover_start.sh
 障害ノードの監視およびフローティングIPの付け替えは行いません。
 また、障害が発生したデータベースが完全に停止した後に実行するように
 してください。
 スクリプト実行後にフローティングIPの付け替えを行ってください。

fback_start.sh
 障害ノードの監視およびフローティングIPの付け替えは行いません。
 また、縮退稼動しているデータベースが起動しており、障害ノードが
 完全に停止している状態で実行するようにしてください。
 本スクリプトはsshでリモートノードのコマンドを実行するため、
 ノード間のssh通信がパスフレーズなしで行えるようになっている
 必要があります。
 スクリプト実行後にフローティングIPの付け替えを行ってください。
